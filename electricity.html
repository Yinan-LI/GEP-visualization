<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Electricity</title>

    <script src="lib/jquery.js"></script>
    <script src="lib/echarts.min.js"></script>
    <script src="lib/china.js"></script>

    <script type="text/javascript" src="lib/P_name.js"></script>
    <script type="text/javascript" src="lib/P_coordinate_adj.js"></script>

    <script type="text/javascript" src="json/EB_2050BAU.js"></script>
    <script type="text/javascript" src="json/EB_2050A.js"></script>
    <script type="text/javascript" src="json/EB_2050B.js"></script>
</head>
<body>
    <div class="wrap" style="position: relative;">
        <div id="map" style="width: 100%; height: 900px;"></div>
    </div>
    
    <script>
    var scenario = prompt('Please enter scenario number:\n0 for 2050 business-as-usual\n1 for 2050 A nexus\n2 for 2050 B nexus');
    switch (scenario){
        case '0':
            resultJson = resultJson0;
            break;
        case '1':
            resultJson = resultJson1;
            break;
        case '2':
            resultJson = resultJson2;
            break;
        default:
            window.alert('Invalid input! Please refresh page to enter again.');
    };

    var myChart = echarts.init(document.getElementById('map'));
    
    var nameMap = nameJson;
    var geoCoordMap = coordinateJson;
    var supplyData = resultJson.supply;
    var capacityData = resultJson.capacity;
    var areaData = resultJson.area;
    var flowData = resultJson.flow;
    var scale = resultJson.scale;
    var title = resultJson.title;
    
    var tech =      ['coal',    'coal-CCS', 'natural gas', 'natural gas-CCS', 'nuclear', 'hydro',   'wind',    'solar',   'biomass', 'BECCS'];
    var colorList = ['#546570', '#8e8e8e',  '#c23531',     '#d48265',         '#913d88', '#61a0a8', '#c4ccd3', '#f7ca18', '#749f83', '#91c7ae'];

    var option = {
        tooltip: {
            trigger: 'item'
        },
        geo: {
            map: 'china',
            roam: true,
            zoom: 1,
            aspectScale: 0.75,
            label: {
                emphasis: {
                    show: false,
                }
            },
            itemStyle: {
                normal: {
                    areaColor: '#ffe7eb',
                    borderColor: 'white'
                },
                emphasis: {
                    areaColor: '#db7093'
                }
            },
            nameMap: nameMap
        },
        visualMap: {
            min: 0,
            max: scale[0],
            left: 450,
            show : true,
            calculable: true,
            seriesIndex: 0,
            color: ['#ff728a','#ff859a','#ff99ab','#ffacbb','#ffc0cb','#ffd4db','#ffe7eb'],
            textStyle:{
                color: 'black'
            }
        },
        title:{
            show: true,
            text: 'Electricity generation technologies: ' + title[0],
            textStyle:{
                color: 'black'
            },
            subtext: '\n- total electricity generation = ' + title[1].toFixed(1) + ' TWh' +
                     '\n\n- percentage of waste intermittent capacity = ' + (title[2]*100).toFixed(1) + '%',
            subtextStyle:{
                color: 'black',
                fontSize: 14
            },
            left: 450,
            top: 40
        },
        graphic:{
            elements:[
                {
                    type: 'text',
                    left: 454.5,
                    bottom: 180,
                    style:{
                        text: 'generation (TWh)',
                        font: 'normal 13.5px sans-serif'
                    }
                }
            ]
        },
        toolbox:{
                show: true,
                feature:{
                    saveAsImage: {show: true, title: 'save as image'}
                }
        },
        series: []
    };

    myChart.setOption(option);

    function renderEachCity() {
        var option = {
            series: [{
                name: 'area',
                type: 'map',
                map: 'china',
                geoIndex: 0,
                tooltip:{
                    formatter: function(params){ return }
                },
                data: areaData
            },{
                type: 'pie',
                radius: 45,
                center: [675,800],
                label:{
                    show: true,
                    formatter: function(params){
                        return tech[params.dataIndex];
                    },
                    color: 'black'
                },
                labelLine:{
                    show: true,
                    lineStyle:{
                        color: 'gray'
                    }
                },
                itemStyle:{
                    color: function(params){
                        return colorList[params.dataIndex];
                    }
                },
                tooltip:{
                    formatter: function(params){
                        return
                    }
                },
                animation: true,
                data: [1,1,1,1,1,1,1,1,1,1]
            }]
        };

        echarts.util.each(supplyData, function(dataItem, idx) {
            
            var geoCoord = geoCoordMap[dataItem.name];
            var coord = myChart.convertToPixel('geo', geoCoord);

            option.series.push({
                type: 'pie',
                // radius: Math.sqrt(dataItem.total)/scale[1],
                radius: Math.round(dataItem.total) > 0 ? 20 : 0,
                center: coord,
                label:{
                    show: false,
                },
                labelLine:{
                    show: false
                },
                itemStyle:{
                    color: function(params){
                        return colorList[params.dataIndex];
                    }
                },
                tooltip:{
                    formatter: function(params){
                        return '[' + supplyData[params.seriesIndex - 2].name + '] ' + tech[params.dataIndex] + ': ' + 
                                Math.round(params.data*10)/10.0 + ' TWh (' + params.percent + '%)'
                    }
                },
                animation: false,
                data: dataItem.value
            });
        });
        console.time('a');
        myChart.setOption(option, {notMerge: false});
        console.timeEnd('a');
    }

    setTimeout(renderEachCity, 0);

    function throttle(fn, delay, debounce) {

        var currCall;
        var lastCall = 0;
        var lastExec = 0;
        var timer = null;
        var diff;
        var scope;
        var args;

        delay = delay || 0;

        function exec() {
            lastExec = (new Date()).getTime();
            timer = null;
            fn.apply(scope, args || []);
        }

        var cb = function() {
            currCall = (new Date()).getTime();
            scope = this;
            args = arguments;
            diff = currCall - (debounce ? lastCall : lastExec) - delay;

            clearTimeout(timer);

            if (debounce) {
                timer = setTimeout(exec, delay);
            } else {
                if (diff >= 0) {
                    exec();
                } else {
                    timer = setTimeout(exec, -diff);
                }
            }

            lastCall = currCall;
        };

        return cb;
    }

    var throttledRenderEachCity = throttle(renderEachCity, 0);
    myChart.on('geoRoam', throttledRenderEachCity);

    myChart.on('click',function(e){
        if(e.componentSubType == "pie" || e.componentSubType == "map"){
            var idx = e.componentSubType == "pie" ? e.seriesIndex - 2 : e.dataIndex
            if (idx == -1){
                return
            }
            creatWrap();
            var divObj = document.createElement('div');
            divObj.id = 'detail';
            var divX = getMousePos()['x']; 
            var divY = getMousePos()['y']; 
            $(divObj).css({
                'width': 450,
                'height': 250,
                'border': '1px solid #ccc',
                'position': 'absolute',
                'top': divY,
                'left': divX
            }).appendTo('.wrap');
            plotBarChart(idx).on('click', function(e){
                if (e.componentSubType == "bar"){
                    plotSankeyChart(idx)
                }
            });
            clearWrap('.cover');
        }
        return;
    });

    function getMousePos(e) {
        var e = event || window.event;
        var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
        var x = e.pageX || e.clientX + scrollX;
        var y = e.pageY || e.clientY + scrollY;
        return {'x': x,'y': y};
    }
    
    function plotBarChart(idx) {
        var barChart = echarts.init(document.getElementById('detail'));
        var option = {
            backgroundColor: 'rgba(255,255,255,.6)',
            grid:{
                left: 60,
            },
            xAxis: [
                {
                    type: 'category',
                    data: ['CO','NG','NU','HY','WD','SO','BM']
                }
            ],
            yAxis: [
                {
                    splitLine: {
                        show: false
                    },
                    type: 'value',
                    min: 0,
                    max: scale[2],
                    name: 'electricity (TWh)',
                    nameLocation: 'end',
                    nameGap: 15,
                    nameTextStyle:{
                        fontStyle: 'bold'
                    }
                }
            ],
            series: []
        };
        echarts.util.each(supplyData[idx].stack, function(dataItem, idx) {
            option.series.push({
                type: 'bar',
                stack: 'supply',
                barWidth: 20,
                itemStyle: {
                    color: function(params){
                        return idx == 0 ? [colorList[0], colorList[2], colorList[4], colorList[5], colorList[6], colorList[7], colorList[8]][params.dataIndex] :
                                          [colorList[1], colorList[3], colorList[4], colorList[5], colorList[6], colorList[7], colorList[9]][params.dataIndex];
                    }
                },
                label: {
                    show: true,
                    position: 'inside',
                    fontSize: 6,
                    textStyle: {
                        color: 'black'
                    },
                    formatter: function(params){
                        return Math.round(params.data) > 0 ? Math.round(params.data) : ''
                    }
                },
                emphasis:{
                    label:{
                        show: true,
                        position: 'top',
                        fontStyle: 'bold',
                        fontSize: 20,
                        formatter: function(params){
                            return Math.round(params.data)
                        }
                    },
                    itemStyle:{
                        barBorderColor: 'white',
                        barBorderWidth: 4.5
                    }
                },
                data: dataItem
            })
        }); 
        option.series.push({
            type: 'bar',
            stack: 'capacity',
            barWidth: 20,
            barGap: 0,
            itemStyle: {
                color: 'gray'
            },
            label: {
                show: true,
                position: 'inside',
                fontSize: 6,
                textStyle: {
                    color: 'black'
                },
                formatter: function(params){
                    return Math.round(params.data) > 0 ? Math.round(params.data) : ''
                }
            },
            emphasis:{
                label:{
                    show: true,
                    position: 'top',
                    fontStyle: 'bold',
                    fontSize: 20,
                    formatter: function(params){
                        return Math.round(params.data)
                    }
                },
                itemStyle:{
                    barBorderColor: 'white',
                    barBorderWidth: 4.5
                }
            },
            data: capacityData[idx].value
        });
        barChart.setOption(option);
        return barChart;
    }
    
    function plotSankeyChart(idx) {
        var sankeyChart = echarts.init(document.getElementById('detail'));
        var option = {
            backgroundColor: 'rgba(255,255,255,.4)',
            tooltip: {
                trigger: 'item',
                triggerOn: 'mousemove'
            },
            series: [
                {
                    type: 'sankey',
                    focusNodeAdjacency: 'allEdges',
                    layoutIterations: 0,
                    lineStyle:{
                        curveness: 0.5
                    },
                    label:{
                        fontSize: 12
                    },
                    nodeGap: 20,
                    height: 160*scale[3][idx] + 40,
                    top: Math.min(7.5/scale[3][idx], 25).toString() + '%',
                    right: '30%',
                    tooltip:{
                        formatter: function(params){
                            if (params.dataType == 'node'){
                                var nodeInfo = params.name + ': ' + Math.round(params.value*10)/10.0 + ' TWh';
                                var hydro, wind, solar, generation, immediate, other, waste;
                                var h_g, h_w, w_g, w_w, s_g, s_w, g_i, g_o;
                                (function(dataItem){
                                    for (var i = 0; i < dataItem.data.length; i++){
                                        switch (dataItem.data[i].name){
                                            case 'hydro':
                                                hydro = dataItem.data[i].value;
                                                break;
                                            case 'wind':
                                                wind = dataItem.data[i].value;
                                                break;
                                            case 'solar':
                                                solar = dataItem.data[i].value;
                                                break;
                                            case 'generation':
                                                generation = dataItem.data[i].value;
                                                break;
                                            case 'other usage':
                                                other = dataItem.data[i].value;
                                                break;
                                            case 'immediate usage':
                                                immediate = dataItem.data[i].value;
                                                break;
                                            case 'waste':
                                                waste = dataItem.data[i].value;
                                                break;
                                        }
                                    }
                                    for (var i = 0; i < dataItem.links.length; i++){
                                        if (dataItem.links[i].source == 'hydro' && dataItem.links[i].target == 'generation'){
                                            h_g = dataItem.links[i].value;
                                        } else if (dataItem.links[i].source == 'hydro' && dataItem.links[i].target == 'waste'){
                                            h_w = dataItem.links[i].value;
                                        } else if (dataItem.links[i].source == 'wind' && dataItem.links[i].target == 'generation'){
                                            w_g = dataItem.links[i].value;
                                        } else if (dataItem.links[i].source == 'wind' && dataItem.links[i].target == 'waste'){
                                            w_w = dataItem.links[i].value;
                                        } else if (dataItem.links[i].source == 'solar' && dataItem.links[i].target == 'generation'){
                                            s_g = dataItem.links[i].value;
                                        } else if (dataItem.links[i].source == 'solar' && dataItem.links[i].target == 'waste'){
                                            s_w = dataItem.links[i].value;
                                        } else if (dataItem.links[i].source == 'generation' && dataItem.links[i].target == 'immediate usage'){
                                            g_i = dataItem.links[i].value;
                                        } else if (dataItem.links[i].source == 'generation' && dataItem.links[i].target == 'other usage'){
                                            g_o = dataItem.links[i].value;
                                        }
                                    }
                                    hydro = hydro || 0, wind = wind || 0, solar = solar || 0, 
                                    generation = generation || 0, 
                                    immediate = immediate || 0, other = other || 0, waste = waste || 0;
                                    h_g = h_g || 0, h_w = h_w || 0, 
                                    w_g = w_g || 0, w_w = w_w || 0, 
                                    s_g = s_g || 0, s_w = s_w || 0, 
                                    g_i = g_i || 0, g_o = g_o || 0;
                                })(flowData[idx]);
                                
                                if (params.name == 'hydro'){
                                    nodeInfo = nodeInfo + '<br/>' +
                                    '> generation: ' + Math.round(h_g*10)/10.0 + '  TWh (' + Math.round(h_g/hydro*100*100)/100.0 + '%)<br/>' +
                                    '> waste: ' + Math.round(h_w*10)/10.0 + ' TWh (' + Math.round(h_w/hydro*100*100)/100.0 + '%)';
                                } else if (params.name == 'wind'){
                                    nodeInfo = nodeInfo + '<br/>' +
                                    '> generation: ' + Math.round(w_g*10)/10.0 + ' TWh (' + Math.round(w_g/wind*100*100)/100.0 + '%)<br/>' +
                                    '> waste: ' + Math.round(w_w*10)/10.0 + ' TWh (' + Math.round(w_w/wind*100*100)/100.0 + '%)';
                                } else if (params.name == 'solar'){
                                    nodeInfo = nodeInfo + '<br/>' +
                                    '> generation: ' + Math.round(s_g*10)/10.0 + ' TWh (' + Math.round(s_g/solar*100*100)/100.0 + '%)<br/>' +
                                    '> waste: ' + Math.round(s_w*10)/10.0 + ' TWh (' + Math.round(s_w/solar*100*100)/100.0 + '%)';
                                } else if (params.name == 'generation'){
                                    nodeInfo = nodeInfo + '<br/>' +
                                    'hydro >: ' + Math.round(h_g*10)/10.0 + ' TWh (' + Math.round(h_g/generation*100*100)/100.0 + '%)<br/>' +
                                    'wind >: ' + Math.round(w_g*10)/10.0 + ' TWh (' + Math.round(w_g/generation*100*100)/100.0 + '%)<br/>' +
                                    'solar >: ' + Math.round(s_g*10)/10.0 + ' TWh (' + Math.round(s_g/generation*100*100)/100.0 + '%)<br/>' +
                                    '> immediate usage: ' + Math.round(g_i*10)/10.0 + ' TWh (' + Math.round(g_i/generation*100*100)/100.0 + '%)<br/>'+
                                    '> other usage: ' + Math.round(g_o*10)/10.0 + ' TWh (' + Math.round(g_o/generation*100*100)/100.0 + '%)';
                                } else if (params.name == 'immediate usage'){
                                    nodeInfo = nodeInfo + '<br/>' +
                                    'generation >: ' + Math.round(g_i*10)/10.0 + ' TWh (' + Math.round(g_i/immediate*100*100)/100.0 + '%)';
                                } else if (params.name == 'other usage'){
                                    nodeInfo = nodeInfo + '<br/>' +
                                    'generation >: ' + Math.round(g_o*10)/10.0 + ' TWh (' + Math.round(g_o/other*100*100)/100.0 + '%)';
                                } else if (params.name == 'waste'){
                                    nodeInfo = nodeInfo + '<br/>' +
                                    'hydro >: ' + Math.round(h_w*10)/10.0 + ' TWh (' + Math.round(h_w/waste*100*100)/100.0 + '%)<br/>' +
                                    'wind >: ' + Math.round(w_w*10)/10.0 + ' TWh (' + Math.round(w_w/waste*100*100)/100.0 + '%)<br/>' +
                                    'solar >: ' + Math.round(s_w*10)/10.0 + ' TWh (' + Math.round(s_w/waste*100*100)/100.0 + '%)';
                                }
                                return nodeInfo;
                            }
                            else{
                                return params.data.source + ' to ' + params.data.target + ': ' + Math.round(params.value*10)/10.0 + ' TWh';
                            }
                        }
                    },
                    data: flowData[idx].data,
                    links: flowData[idx].links
                }
            ]
        };
        sankeyChart.setOption(option, true);
    }
    
    function creatWrap(){
        var cover = document.createElement('div');
        $(cover).addClass('cover').css({
            width: '100%',
            height: '100%',
            position: 'absolute',
            top: 0,
            left: 0,
            backgroundColor: 'rgba(0,0,0,.2)'
        }).appendTo('.wrap');
    }
    
    function clearWrap(id){
        $(id).click(function(e){
            this.remove();
            $('#detail').remove();
            return false;
        });
    }
    </script>
</body>
</html>